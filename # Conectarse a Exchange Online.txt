# Conectarse a Exchange Online
Connect-ExchangeOnline -UserPrincipalName johan.rusinque@alcabama.com.co

# Reporte actualizado con parseo de tamaños
Get-Mailbox -ResultSize Unlimited -ErrorAction SilentlyContinue | ForEach-Object {
    try {
        $mbx = $_

        # Estadísticas del buzón
        $stats = Get-MailboxStatistics -Identity $mbx.UserPrincipalName -ErrorAction SilentlyContinue
        $quotaObj = Get-Mailbox -Identity $mbx.UserPrincipalName -ErrorAction SilentlyContinue

        # Usar regex para sacar solo el valor numérico en GB
        $usedGB = if ($stats -and $stats.TotalItemSize) {
            if ($stats.TotalItemSize.ToString() -match "([\d.,]+)\s+GB") {
                [math]::Round([double]$matches[1].Replace(",",".") , 2)
            } else { 0 }
        } else { 0 }

        $quotaGB = if ($quotaObj -and $quotaObj.ProhibitSendQuota) {
            if ($quotaObj.ProhibitSendQuota.ToString() -match "([\d.,]+)\s+GB") {
                [math]::Round([double]$matches[1].Replace(",",".") , 2)
            } else { 0 }
        } else { 0 }

        if ($quotaGB -gt 0) {
            $percentUsed = [math]::Round(($usedGB / $quotaGB) * 100, 2)
            $percentRemaining = 100 - $percentUsed
        } else {
            $percentUsed = 0
            $percentRemaining = 0
        }

        # Crear objeto final
        [PSCustomObject]@{
            Correo             = $mbx.PrimarySmtpAddress
            Usuario            = $mbx.DisplayName
            EspacioTotal_GB    = $quotaGB
            EspacioUsado_GB    = $usedGB
            PorcentajeUsado    = $percentUsed
            PorcentajeRestante = $percentRemaining
            ConteoCorreos      = if ($stats) { $stats.ItemCount } else { 0 }
        }
    }
    catch {
        Write-Host "Error con buzón $($mbx.UserPrincipalName): $($_.Exception.Message)" -ForegroundColor Yellow
    }
} | Export-Csv "C:\Users\kevin.perez\Downloads\Reporte_Buzones_PowerBI.csv" -NoTypeInformation -Encoding UTF8 -Force
